<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>XSS テスト - IC Learning Visualizer</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .test-section {
      margin: 20px;
      padding: 20px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
    }
    .test-case {
      margin: 10px 0;
      padding: 10px;
      background: #0b1220;
      border-radius: 4px;
    }
    .test-title {
      font-weight: bold;
      color: var(--accent);
      margin-bottom: 5px;
    }
    .test-input {
      color: var(--muted);
      font-family: monospace;
      margin: 5px 0;
    }
    .test-result {
      color: var(--accent2);
      margin-top: 5px;
    }
    .pass { color: var(--accent2); }
    .fail { color: var(--danger); }
  </style>
</head>
<body>
  <main class="container">
    <h1>XSS攻撃パターンテスト</h1>
    
    <div class="test-section">
      <h2>テストケース</h2>
      <div id="testResults"></div>
    </div>

    <div class="test-section">
      <h2>手動テスト用フォーム</h2>
      <textarea id="inputText" rows="4" placeholder="XSSテストパターンを入力..."></textarea>
      <div class="buttons">
        <button id="btnCalc" class="primary">ICを計算</button>
      </div>
      <div id="output" style="margin-top: 20px;">
        <div>N: <span id="N">0</span></div>
        <div>IC: <span id="IC" class="badge">0.0000</span></div>
      </div>
    </div>

    <!-- 隠しエリア（XSS成功時に表示される） -->
    <div id="freqChart" style="display:none;"></div>
    <div id="sumNi" style="display:none;"></div>
    <div id="denom" style="display:none;"></div>
    <div id="sumPi2" style="display:none;"></div>
    <div id="normalizeAZ" style="display:none;"></div>
    <div id="removeSpaces" style="display:none;"></div>
  </main>

  <script src="script.js"></script>
  <script>
    // XSSテストパターン
    const xssPatterns = [
      {
        name: "基本的なscriptタグ注入",
        input: '<script>alert("XSS")</script>',
        description: "scriptタグによるJavaScript実行試行"
      },
      {
        name: "imgタグのonerror属性",
        input: '<img src=x onerror="alert(\'XSS\')">',
        description: "画像エラーイベントハンドラーによる実行試行"
      },
      {
        name: "JavaScriptプロトコル",
        input: '<a href="javascript:alert(\'XSS\')">Click</a>',
        description: "javascript:プロトコルによる実行試行"
      },
      {
        name: "イベントハンドラー属性",
        input: '<div onmouseover="alert(\'XSS\')">Hover me</div>',
        description: "マウスイベントハンドラーによる実行試行"
      },
      {
        name: "SVGタグ注入",
        input: '<svg onload="alert(\'XSS\')"></svg>',
        description: "SVGのonloadイベントによる実行試行"
      },
      {
        name: "エンコードされたscript",
        input: '%3Cscript%3Ealert(%27XSS%27)%3C/script%3E',
        description: "URLエンコードされたscriptタグ"
      },
      {
        name: "HTMLエンティティ",
        input: '&lt;script&gt;alert(&quot;XSS&quot;)&lt;/script&gt;',
        description: "HTMLエンティティでエンコードされたscript"
      },
      {
        name: "データURI",
        input: '<object data="data:text/html;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4="></object>',
        description: "Base64エンコードされたデータURI"
      },
      {
        name: "スタイル属性でのexpression",
        input: '<div style="width:expression(alert(\'XSS\'))">Test</div>',
        description: "CSSのexpressionによる実行試行（IE向け）"
      },
      {
        name: "混合大小文字",
        input: '<ScRiPt>alert("XSS")</sCrIpT>',
        description: "大小文字を混ぜたscriptタグ"
      },
      {
        name: "ヌルバイト注入",
        input: '<script>alert\x00("XSS")</script>',
        description: "ヌルバイトを含むscript"
      },
      {
        name: "Unicode文字",
        input: '<script>alert\u0028"XSS"\u0029</script>',
        description: "Unicodeエスケープシーケンス"
      },
      {
        name: "長大な入力",
        input: 'A'.repeat(100001),
        description: "10万文字を超える入力（DoS試行）"
      },
      {
        name: "特殊記号の組み合わせ",
        input: '"><script>alert("XSS")</script><"',
        description: "引用符とタグの組み合わせ"
      }
    ];

    // テスト実行
    function runTests() {
      const resultsDiv = document.getElementById('testResults');
      resultsDiv.innerHTML = '';
      
      let passCount = 0;
      let failCount = 0;

      xssPatterns.forEach((pattern, index) => {
        const testDiv = document.createElement('div');
        testDiv.className = 'test-case';
        
        // XSS検出用のフラグ
        let xssDetected = false;
        
        // alertを一時的にオーバーライド
        const originalAlert = window.alert;
        window.alert = function() {
          xssDetected = true;
        };
        
        // evalを一時的にオーバーライド
        const originalEval = window.eval;
        window.eval = function() {
          xssDetected = true;
          return undefined;
        };
        
        try {
          // テスト入力を処理
          const inputEl = document.getElementById('inputText');
          inputEl.value = pattern.input;
          
          // IC計算を実行（ここでXSSが発生する可能性）
          doCalculate();
          
          // DOM要素のチェック
          const allElements = document.querySelectorAll('*');
          for (let el of allElements) {
            // インラインイベントハンドラーの検出
            const attributes = el.attributes;
            for (let attr of attributes) {
              if (attr.name.startsWith('on')) {
                xssDetected = true;
                break;
              }
            }
            
            // scriptタグの検出
            if (el.tagName === 'SCRIPT' && !el.src.includes('script.js')) {
              xssDetected = true;
            }
          }
          
        } catch (e) {
          // エラーが発生した場合（これは正常）
        }
        
        // 元に戻す
        window.alert = originalAlert;
        window.eval = originalEval;
        
        // 結果を表示
        const status = !xssDetected ? 'pass' : 'fail';
        if (!xssDetected) passCount++;
        else failCount++;
        
        testDiv.innerHTML = `
          <div class="test-title">テスト ${index + 1}: ${pattern.name}</div>
          <div class="test-input">入力: ${escapeHtml(pattern.input.substring(0, 100))}${pattern.input.length > 100 ? '...' : ''}</div>
          <div class="test-input">説明: ${pattern.description}</div>
          <div class="test-result ${status}">
            結果: ${!xssDetected ? '✓ PASS (XSSブロック成功)' : '✗ FAIL (XSS検出)'}
          </div>
        `;
        
        resultsDiv.appendChild(testDiv);
      });
      
      // サマリー
      const summaryDiv = document.createElement('div');
      summaryDiv.className = 'test-case';
      summaryDiv.style.marginTop = '20px';
      summaryDiv.innerHTML = `
        <div class="test-title">テスト結果サマリー</div>
        <div class="test-result">
          <span class="pass">成功: ${passCount}</span> / 
          <span class="fail">失敗: ${failCount}</span> / 
          合計: ${xssPatterns.length}
        </div>
        <div class="test-result">
          ${passCount === xssPatterns.length ? 
            '<span class="pass">✓ すべてのXSS攻撃パターンがブロックされました</span>' : 
            '<span class="fail">⚠ 一部のXSS攻撃パターンが検出されました</span>'}
        </div>
      `;
      resultsDiv.appendChild(summaryDiv);
    }

    // ページ読み込み時にテスト実行
    window.addEventListener('DOMContentLoaded', () => {
      setTimeout(runTests, 500);
    });
  </script>
</body>
</html>